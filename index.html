<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f0f2f5; padding: 10px; }
    .app-container { max-width: 500px; margin: auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
    .app-header { background: #0d6efd; color: white; padding: 25px; text-align: center; }
    .form-section { padding: 20px; }
    .farmer-info-card { background: #f8faff; border: 1px dashed #0d6efd; border-radius: 12px; padding: 15px; margin: 15px 0; }
    .info-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
    #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner-border text-primary"></div>
  <p class="mt-2 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>

<div class="app-container">
  <div class="app-header">
    <h3 class="mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ</h3>
    <p class="mb-0 opacity-75 small">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</p>
  </div>

  <div class="form-section">
    <form id="bookingForm">
      <div class="mb-3">
        <label class="form-label small fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤</label>
        <input type="date" id="dateInput" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label small fw-bold">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
        <select id="timeslot" class="form-select"></select>
      </div>

      <div class="mb-3">
        <label class="form-label small fw-bold">üöõ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
        <select id="carTypeSelect" class="form-select" onchange="toggleTrailer()">
          <option value="‡∏™‡∏¥‡∏ö‡∏•‡πâ‡∏≠">‡∏™‡∏¥‡∏ö‡∏•‡πâ‡∏≠</option>
          <option value="‡∏´‡∏Å‡∏•‡πâ‡∏≠">‡∏´‡∏Å‡∏•‡πâ‡∏≠</option>
          <option value="‡πÅ‡∏°‡πà‡∏û‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á">‡πÅ‡∏°‡πà‡∏û‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á</option>
          <option value="‡∏≠‡∏µ‡πÅ‡∏ï‡πã‡∏ô">‡∏≠‡∏µ‡πÅ‡∏ï‡πã‡∏ô</option>
          <option value="‡πÄ‡∏ó‡∏£‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå">‡πÄ‡∏ó‡∏£‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label small fw-bold">üÜî ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
        <input type="text" id="plate" class="form-control" placeholder="89-XXXX" required>
      </div>

      <div id="divTrailer" class="mb-3" style="display:none;">
        <label class="form-label small fw-bold text-danger">üÜî ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á</label>
        <input type="text" id="iTrailer" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label small fw-bold text-primary">üî¢ ‡πÄ‡∏•‡∏Ç‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà</label>
        <input type="number" id="qInput" class="form-control border-primary" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="searchData()">
      </div>

      <div class="farmer-info-card shadow-sm">
        <div class="info-line"><span>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà:</span><span id="vFarmer" class="fw-bold text-primary">-</span></div>
        <div class="info-line"><span>‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£:</span><span id="vOfficer">-</span></div>
        <div class="info-line"><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span><span id="vPhone" class="text-success">-</span></div>
      </div>

      <button type="submit" class="btn btn-primary w-100 p-3 fw-bold mt-2" style="border-radius:12px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
    </form>
  </div>
</div>

<script>
  // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà 1 (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô gid=0 ‡∏ï‡∏≤‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  const FETCH_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbEDGmPQBvhjfD6GmwALpmrTH8jNuEGoe3eUVANXZtvFuG8PTNDFNOsUfi6xZYO98D8JBY3ghQ82CQ/pub?gid=0&single=true&output=csv';
  
  // URL ‡∏Ç‡∏≠‡∏á Web App ‡∏à‡∏≤‡∏Å Google Apps Script (‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)
  const SCRIPT_URL = '‡πÉ‡∏™‡πà_WEB_APP_URL_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';

  let farmerData = null;
  let timer;

  window.onload = () => {
    document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
    const s = document.getElementById('timeslot');
    ["08:01-09:00", "09:01-10:00", "10:01-11:00", "11:01-12:00", "12:01-13:00", "13:01-14:00", "14:01-15:00", "15:01-16:00", "16:01-17:00", "17:01-18:00", "18:01-19:00", "19:01-20:00", "20:01-21:00", "21:01-22:00", "22:01-23:00", "23:01-00:00", "00:01-02:00", "02:01-03:00", "03:01-04:00", "04:01-05:00", "05:01-06:00", "06:01-07:00", "07:01-08:00"].forEach(t => s.options.add(new Option(t, t)));
  };

  function toggleTrailer() {
    const isP = document.getElementById('carTypeSelect').value === '‡πÅ‡∏°‡πà‡∏û‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á';
    document.getElementById('divTrailer').style.display = isP ? 'block' : 'none';
    document.getElementById('iTrailer').required = isP;
  }

  async function searchData() {
    const q = document.getElementById('qInput').value.trim();
    if (q.length < 3) { resetInfo(); return; }

    document.getElementById('vFarmer').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
    clearTimeout(timer);

    timer = setTimeout(async () => {
      try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô Proxy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å
        const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(FETCH_URL + '&t=' + Date.now()));
        const json = await response.json();
        const rows = json.contents.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));
        
        const found = rows.find(r => r[0] === q);
        if (found) {
          document.getElementById('vFarmer').innerText = found[1];
          document.getElementById('vOfficer').innerText = found[2];
          document.getElementById('vPhone').innerText = found[3] || "-";
          farmerData = { name: found[1], officer: found[2], phone: found[3] || "-" };
        } else {
          document.getElementById('vFarmer').innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤";
          farmerData = null;
        }
      } catch (e) {
        document.getElementById('vFarmer').innerText = "‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
      }
    }, 500);
  }

  function resetInfo() {
    document.getElementById('vFarmer').innerText = "-";
    document.getElementById('vOfficer').innerText = "-";
    document.getElementById('vPhone').innerText = "-";
    farmerData = null;
  }

  document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!farmerData) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà', 'warning');

    document.getElementById('loader').style.display = 'flex';
    const payload = {
      date: document.getElementById('dateInput').value,
      timeslot: document.getElementById('timeslot').value,
      carType: document.getElementById('carTypeSelect').value,
      plate: document.getElementById('plate').value,
      trailerPlate: document.getElementById('iTrailer').value,
      quota: document.getElementById('qInput').value,
      farmerName: farmerData.name,
      officerName: farmerData.officer,
      phone: farmerData.phone
    };

    try {
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      const out = await res.json();
      document.getElementById('loader').style.display = 'none';
      if (out.success) {
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', out.message, 'success').then(() => location.reload());
      }
    } catch (err) {
      document.getElementById('loader').style.display = 'none';
      Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Web App URL', 'error');
    }
  });
</script>
</body>
</html>
