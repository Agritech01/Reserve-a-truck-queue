<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-blue: #0d6efd; --bg-gray: #f0f2f5; }
    body { background-color: var(--bg-gray); font-family: 'Prompt', sans-serif; }
    .app-container { max-width: 480px; margin: auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
    .app-header { background: var(--primary-blue); color: white; padding: 30px 20px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; text-align: center; margin-bottom: 25px; }
    .form-section { padding: 0 20px 30px 20px; }
    .form-control, .form-select { border-radius: 12px; padding: 12px 15px; margin-bottom: 10px; }
    .farmer-info-card { background: #f8faff; border: 1px dashed #0d6efd; border-radius: 15px; padding: 15px; margin: 20px 0; }
    .info-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #edf2f7; padding-bottom: 5px; }
    .info-label { color: #718096; font-size: 0.85rem; }
    .info-value { font-weight: 600; color: #2d3748; }
    #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
  </style>
</head>
<body>

  <div id="loader">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>

  <div class="app-container">
    <div class="app-header shadow">
      <h3 class="mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ</h3>
      <p class="mb-0 opacity-75 small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</p>
    </div>

    <div class="form-section">
      <form id="bookingForm">
        <label class="form-label small fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤</label>
        <input type="date" id="dateInput" class="form-control" required>

        <label class="form-label small fw-bold">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
        <select id="timeslot" class="form-select"></select>

        <label class="form-label small fw-bold">üöõ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
        <select id="carTypeSelect" class="form-select" onchange="toggleTrailer()">
          <option value="‡∏™‡∏¥‡∏ö‡∏•‡πâ‡∏≠">‡∏™‡∏¥‡∏ö‡∏•‡πâ‡∏≠</option>
          <option value="‡∏´‡∏Å‡∏•‡πâ‡∏≠">‡∏´‡∏Å‡∏•‡πâ‡∏≠</option>
          <option value="‡πÅ‡∏°‡πà‡∏û‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á">‡πÅ‡∏°‡πà‡∏û‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á</option>
          <option value="‡∏≠‡∏µ‡πÅ‡∏ï‡πã‡∏ô">‡∏≠‡∏µ‡πÅ‡∏ï‡πã‡∏ô</option>
          <option value="‡πÄ‡∏ó‡∏£‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå">‡πÄ‡∏ó‡∏£‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå</option>
        </select>

        <div id="divPlate">
          <label class="form-label small fw-bold">üÜî ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
          <input type="text" id="plate" class="form-control" placeholder="89-XXXX" required>
        </div>
        
        <div id="divTrailer" style="display:none;">
          <label class="form-label small fw-bold text-danger">üÜî ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á</label>
          <input type="text" id="iTrailer" class="form-control" placeholder="89-XXXX">
        </div>

        <label class="form-label small fw-bold">üî¢ ‡πÄ‡∏•‡∏Ç‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà</label>
        <input type="number" id="qInput" class="form-control border-primary" inputmode="numeric" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤" oninput="searchData()">

        <div class="farmer-info-card">
          <div class="info-item"><span class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà</span><span id="vFarmer" class="info-value text-primary">-</span></div>
          <div class="info-item"><span class="info-label">‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏î‡∏π‡πÅ‡∏•</span><span id="vOfficer" class="info-value">-</span></div>
          <div class="info-item" style="border:none;"><span class="info-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span><span id="vPhone" class="info-value text-success">-</span></div>
        </div>

        <button type="submit" id="btnSubmit" class="btn btn-primary w-100 p-3 shadow-sm fw-bold" style="border-radius:15px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
      </form>
    </div>
  </div>

  <script>
    // 1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà 1 (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbEDGmPQBvhjfD6GmwALpmrTH8jNuEGoe3eUVANXZtvFuG8PTNDFNOsUfi6xZYO98D8JBY3ghQ82CQ/pub?gid=151049282&single=true&output=csv';
    
    // 2. URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà 2
    const SCRIPT_URL = '‡πÉ‡∏™‡πà_WEB_APP_URL_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';

    let farmerData = null;

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateInput').value = today;
      const s = document.getElementById('timeslot');
      const slots = ["08:01 - 09:00", "09:01 - 10:00", "10:01 - 11:00", "11:01 - 12:00", "12:01 - 13:00", "13:01 - 14:00", "14:01 - 15:00", "15:01 - 16:00", "16:01 - 17:00", "17:01 - 18:00", "18:01 - 19:00", "19:01 - 20:00", "20:01 - 21:00", "21:01 - 22:00", "22:01 - 23:00", "23:01 - 00:00", "00:01 - 02:00", "02:01 - 03:00", "03:01 - 04:00", "04:01 - 05:00", "05:01 - 06:00", "06:01 - 07:00", "07:01 - 08:00"];
      slots.forEach(t => s.options.add(new Option(t, t)));
    };

    function toggleTrailer() {
      const isP = document.getElementById('carTypeSelect').value === '‡πÅ‡∏°‡πà‡∏û‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡πà‡∏ß‡∏á';
      document.getElementById('divTrailer').style.display = isP ? 'block' : 'none';
      document.getElementById('iTrailer').required = isP;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤‡πÅ‡∏•‡∏ö (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô Apps Script)
    async function searchData() {
      const q = document.getElementById('qInput').value.trim();
      if(q.length < 5) { resetInfo(); return; }

      try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const rows = text.split('\n').map(row => row.split(','));
        
        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ Column A=‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤(0), B=‡∏ä‡∏∑‡πà‡∏≠(1), C=‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£(2), D=‡πÄ‡∏ö‡∏≠‡∏£‡πå(3)
        const found = rows.find(r => r[0].trim() === q);

        if(found) {
          document.getElementById('vFarmer').innerText = found[1];
          document.getElementById('vOfficer').innerText = found[2];
          document.getElementById('vPhone').innerText = found[3] || "-";
          farmerData = { name: found[1], officer: found[2], phone: found[3] || "-" };
        } else {
          document.getElementById('vFarmer').innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
          resetInfo();
        }
      } catch (e) { console.error("Search Error:", e); }
    }

    function resetInfo() {
      document.getElementById('vFarmer').innerText = "-";
      document.getElementById('vOfficer').innerText = "-";
      document.getElementById('vPhone').innerText = "-";
      farmerData = null;
    }

    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!farmerData) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning');

      document.getElementById('loader').style.display = 'flex';
      
      const payload = {
        date: document.getElementById('dateInput').value,
        timeslot: document.getElementById('timeslot').value,
        carType: document.getElementById('carTypeSelect').value,
        plate: document.getElementById('plate').value,
        trailerPlate: document.getElementById('iTrailer').value,
        quota: document.getElementById('qInput').value,
        farmerName: farmerData.name,
        officerName: farmerData.officer,
        phone: farmerData.phone
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        document.getElementById('loader').style.display = 'none';
        if(result.success) {
          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success').then(() => location.reload());
        }
      } catch (err) {
        document.getElementById('loader').style.display = 'none';
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå', 'error');
      }
    });
  </script>
</body>
</html>
